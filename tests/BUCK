load("@prelude//prelude.bzl", "alias", "default", "export", "json", "shell", "write")

write(
    name = "write_rule",
    path = "out/write.txt",
    content = "hello from write rule\n",
)

write(
    name = "write_rule_executable",
    path = "out/run.sh",
    content = "#!/bin/sh\necho hello\n",
    executable = True,
)

json(
    name = "json_rule",
    path = "out/data.json",
    content = {"name": "buck2-prelude", "ok": True},
    pretty = True,
)

json(
    name = "json_rule_compact",
    path = "out/data.compact.json",
    content = {"items": [1, 2, 3], "nested": {"ok": True}},
)

export(
    name = "export_rule",
    mode = "copy",
    sources = ["input.txt"],
)

export(
    name = "export_rule_symlink",
    mode = "symlink",
    sources = ["input.txt"],
)

default(
    name = "default_rule_env",
    context = "out/default_env",
    command = ["sh", "-c", "test \"$RULE_ENV\" = \"default\" && touch ok.txt"],
    sources = [],
    environment = {"RULE_ENV": "default"},
    outputs = ["ok.txt"],
)

default(
    name = "default_rule_no_outputs",
    context = "out/default_no_outputs",
    command = ["sh", "-c", "test \"$RULE_ENV\" = \"default-no-outputs\""],
    sources = [],
    environment = {"RULE_ENV": "default-no-outputs"},
)

shell(
    name = "shell_rule_env",
    context = "out/shell_env",
    command = ["test \"$RULE_ENV\" = \"shell\" && touch ok.txt"],
    environment = {"RULE_ENV": "shell"},
    outputs = ["ok.txt"],
)

shell(
    name = "shell_rule_no_outputs",
    context = "out/shell_no_outputs",
    command = ["test \"$RULE_ENV\" = \"shell-no-outputs\""],
    environment = {"RULE_ENV": "shell-no-outputs"},
)

alias(
    name = "all",
    actual = [
        ":write_rule",
        ":write_rule_executable",
        ":json_rule",
        ":json_rule_compact",
        ":export_rule",
        ":export_rule_symlink",
        ":default_rule_env",
        ":default_rule_no_outputs",
        ":shell_rule_env",
        ":shell_rule_no_outputs",
    ],
)
